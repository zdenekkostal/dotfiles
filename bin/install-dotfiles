#!/usr/bin/env bash

cd ~

echo "Installing homebrew"

# Instal brew if not installed yet
if ! command -v brew >/dev/null 2>&1; then
  curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh
fi

echo "Installing homebrew packages"
brew install asdf git tig tmux fzf direnv ripgrep gnupg svgo tldr starship git-delta markdownlint-cli shellcheck bat jq sheldon mas rust-analyzer TankerHQ/homebrew-repo/ruplacer
brew install --HEAD neovim

echo "Installing homebrew applications"
brew install --cask alacritty karabiner-elements cleanshot font-hack-nerd-font spotify notion choosy keka dash muzzle pixelsnap tripmode beardedspice iina viscosity handbrake homebrew/cask-versions/firefox-developer-edition homebrew/cask-fonts/font-fira-code

echo "Installing App store applications"
if defaults read MobileMeAccounts Accounts | grep -q 'AccountID'; then
  brew bundle install --file=brewfile_apps
fi

echo "Installing Tmux plugin manager"
if [ ! -d "$HOME/tmux/plugins/tpm" ]; then
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  ~/.tmux/plugins/tpm/bin/install_plugins
fi

echo "Installing latest versions of languages"
for lang in golang nodejs yarn python rust; do
  asdf plugin-add "$lang"
  asdf install "$lang" latest
  asdf global "$lang" latest
done

echo "Configuring MacOS defaults"
if command -v defaults >/dev/null 2>&1; then
  defaults write -g InitialKeyRepeat -int 15
  defaults write -g KeyRepeat -int 2
fi

alias dotfiles='/usr/bin/git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME'

echo "Cloning the dotfiles"
if [ ! -d "$HOME/.dotfiles" ]; then
  git clone --bare git@github.com:zdenekkostal/dotfiles.git "$HOME/.dotfiles"
  dotfiles config status.showUntrackedFiles no
fi

if dotfiles diff-index --quiet HEAD --; then
  echo "Restoring dotfiles"
  dotfiles restore .
else
  echo "Can't restore dotfiles due to uncommited changes"
  dotfiles diff --stat
  exit 1
fi

[ -f ~/.profile ] && source ~/.profile

echo "Installing Neovim packages and LSP dependencies"
npm install -g @fsouza/prettierd eslint_d typescript-language-server
go install golang.org/x/tools/gopls@latest
nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

echo "Installing keyboard layout"
if [ ! -f "/Library/Keyboard Layouts/Czech_Programmers_0.2.keylayout" ]; then
  cp ./keyboard_layouts/Czech_Programmers_0.2.keylayout /Library/Keyboard Layouts/
fi

echo "Setting up wallpaper"
wallpaper ~/wallpapers/gradiant.heic
